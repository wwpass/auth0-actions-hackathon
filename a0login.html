<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="css/style.min.css" />
  <title>WWPass - Auth0 Auto VPN</title>
</head>

<body class="pageBody">
  <main class="pageMain">
    <div class="content">
      <div class="content__element content__element--first content--center  content--narrow">
        <div class="logo">

        </div>
        <div class="hr"></div>
        <div class="before_connect">
          <ul class="indicators">
            <!-- <li id="indicator_WWPassVPN" class="indicators__indicator indicators__indicator--connected">WWPassVPN: <span class="indicators__status indicators__status--connected">Connected</span></li>
            <li id="indicator_WWPassVPN" class="indicators__indicator indicators__indicator--disconnected">WWPassVPN: <span class="indicators__status indicators__status--disconnected">Disconnected</span></li> -->
          </ul>

            <p class="text">
              <b>Authentication successful</b>
            </p>
            
            <div class="form">
              <p class="text">
                Now your VPN will be connected.
                <button class="button button--action" id="retry" disabled>
                  Try again
                </button>
              </p>
            </div>

            <!-- <p class="text">
              You are not allowed to access VPN
            </p> -->

          <button class="button button--action" id="connect">
            Connect VPN
          </button>
          <p class="text text--marginTop-0">
            Authorization is valid for:<br>
            <span class="button__timer">
              
            </span>
          </p>
        </div>
        <div class="after_connect">
          <h2 class="heading heading--h2 heading--light heading--marginBottom-0">Connecting VPN</h2>
          <p class="text" id="connect_text">
            Your VPN will start automatically.
          </p>
          <button class="button button--action">Reconnect VPN</button>
        </div>
        <div class="timeout_connect" style="display: none;">
          <p class="text">
            Your current connection timed out.
            <button class="button button--action" id="reload">
              Reload page
            </button>
          </p>
        </div>
        <div class="hr"></div>
        <div class="text text--sm">
          <p class="text text--sm">
            If VPN Application does not start, make sure WWPass Connector app is installed.
          </p>
          <p class="text text--sm">
            <a class="text text--sm text--link" href="#TODO">WWPass connector application for&nbsp;Windows</a>
          </p>
        </div>
      </div>
    </div>

  </main>
  <footer class="pageFooter">
    <ul class="pageFooter__nav">
      <li class="pageFooter__item"><span class="text text--sm">Â© WWPASS</span></li>
    </ul>
  </footer>

  <script type="text/javascript">
    window.history.replaceState({}, document.title, document.location.pathname);

    var isMobile = function isMobile() {
      return navigator && `userAgent` in navigator && navigator.userAgent.match(/iPhone|iPod|iPad|Android/i);
    };
    const content = document.querySelector(`.content`);
    const beforeConnect = content.querySelector(`.before_connect`);
    const afterConnect = content.querySelector(`.after_connect`);
    const timeoutConnect = content.querySelector(`.timeout_connect`);
    const buttonReload = content.querySelector(`#reload`);
    const profileSelector = content.querySelector(`#profile_selector`);
    const buttonConnect = content.querySelector(`#connect`);
    const buttonTimer = content.querySelector(`.button__timer`);
    const indicators = document.querySelector(`.indicators`);
    const name = `VPN Status`;
    const check_url = `/probe/probe-demovpn.html`;

    document.addEventListener(`DOMContentLoaded`, () => {
      const indicator = document.createElement(`li`);
      indicator.id = `indicator`;
      indicator.classList.add(`indicators__indicator`);
      let statusElement = ``;

	testConnection(check_url, (status) => {
            if (status) {
              indicator.classList.add(`indicators__indicator--connected`);
              statusElement = `
              <span class="indicators__status indicators__status--connected">Connected</span>`;
            } else {
              indicator.classList.add(`indicators__indicator--disconnected`);
              statusElement = `
              <span class="indicators__status indicators__status--disconnected">Disconnected</span>`;
            }
            indicator.innerHTML = `${name}: ${statusElement}`;
          });

          // indicator.innerHTML = `${name}: ${statusElement}`;

          indicators.appendChild(indicator);
    });

    const setButtonTimer = (seconds) => {
      buttonTimer.innerHTML = `
        ${seconds}
        <span class="button__timerAnimation"></span>`;
    };

    let delay = 30;
    setButtonTimer(delay);

    const delayUpdate = setInterval(() => {
      delay -= 1;
      setButtonTimer(delay);
    }, 1000);
    window.setTimeout(() => { clearInterval(delayUpdate) }, delay * 1000);

    const timeoutConnectUpdate = setTimeout(() => {
      beforeConnect.style.display = `none`;
      timeoutConnect.style.display = `block`;
    }, delay * 1000);

    buttonConnect.addEventListener(`click`, () => {
      clearInterval(delayUpdate);
      clearTimeout(timeoutConnectUpdate);
      const profile = profileSelector.value;
      console.log(`Profile chosen: ${profile}`);
      if (profile === null || profile === ``) {
        return false;
      }
      localStorage.setItem(`last_profile`, profile);
      var vpn_url = profiles[profile].url;
      console.log(`Redirect to: ${vpn_url}`);
      window.open(vpn_url, `_blank`);
      beforeConnect.style.display = `none`;
      afterConnect.style.display = `block`;
      return false;
    });

    buttonReload.addEventListener(`click`, () => {
      location.reload();
    });

    const testConnection = (resource, callback) => {
      let state  = 0; // Indeterminate state
      let controller = null;
      const newStatus = (st) => {
        if (st) {
          if (state != 1) {
              state = 1;
              callback(true);
            }
        } else {
          if (state != -1) {
            state = -1;
            callback(false);
          }
        }
      }
      const tryFetch = () => {
        if (controller !== null)
          controller.abort()
        controller = new AbortController();
        fetch(resource, {
          cache: 'no-store',
          mode: 'no-cors',
          referrerPolicy: 'no-referrer',
          signal: controller.signal
        }).then((response) => {
          if (response.status < 400) {
            newStatus(true);
          } else {
            newStatus(false);
          }
        }, () => {
          newStatus(false);
        })
      };
      tryFetch();
      const id = setInterval(tryFetch, 1000);
      return id;
    }
  </script>
</body>

</html>
